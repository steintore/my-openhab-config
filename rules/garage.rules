import org.openhab.core.library.types.*
import org.openhab.core.persistence.*
import org.openhab.model.script.actions.*

var Timer garageDoorOpen = null

rule "Send a message if garage door has been open for 15 minutes"
	when
		Item garage_door_1 changed to ON or
		Item garage_door_2 changed to ON	
	then
		logInfo("org.openhab.rules","Garage door opened")
		sendCommand(message_received, OFF)
		garageDoorOpen = createTimer(now.plusSeconds(900)) [|
			var t = ""
			if (garage_door_1.state == ON) t = "Leafs"
			else t = "Mondeos" 
			logInfo("org.openhab.rules", t+ " Garage door has been open too long")
			postUpdate(push_message_text, t + " garasjeport er ikke lukket")
			
			if(garageDoorOpen!=null) {
				if(garageDoorOpen.running) {
					garageDoorOpen.cancel()
				}
				garageDoorOpen = null
			}
		]
end

rule "Reset timer if someone closes the garage door, and both is closed"
	when
		Item garage_door_1 changed to OFF or
		Item garage_door_2 changed to OFF
	then
		logInfo("org.openhab.rules", "Garage door closed")
		sendCommand(message_received, OFF)
		if (garage_door_1.state == OFF && garage_door_2.state == OFF) {
			if(garageDoorOpen!=null) {
			garageDoorOpen.cancel
			garageDoorOpen = null
			}
		} else {
			garageDoorOpen.reschedule(now.plusSeconds(1200))
		}	
end

rule "Send a message after 10 minutes if garage door is open and nobody is home"
	when
		Time cron "0 0/10 * * * ?"
	then
		if (mode.state ==  2 && (garage_door_1.state == ON || garage_door_2.state == ON)) {
			if (message_received.state == OFF && !garage_door_1.changedSince(now.minusMinutes(15)) && !garage_door_2.changedSince(now.minusMinutes(15))) {
				postUpdate(push_message_text, "Tydeligvis ingen hjemme, men garasjeporten er Ã¥pen!")
			}
		}
		if (garage_door_1.state == Undefined || garage_door_1.state == Uninitialized) {
        	sendCommand(garage_door_1, OFF)
        }
        if (garage_door_2.state == Undefined || garage_door_2.state == Uninitialized) {
        	sendCommand(garage_door_2, OFF)
        }	
end